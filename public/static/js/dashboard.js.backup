function switchTab(tab) {
    const uploadTab = document.getElementById('upload-tab');
    const manualTab = document.getElementById('manual-tab');
    const tabBtns = document.querySelectorAll('.tab-btn');
    
    tabBtns.forEach(btn => btn.classList.remove('active'));
    
    if (tab === 'upload') {
        uploadTab.classList.add('active');
        manualTab.classList.remove('active');
        tabBtns[0].classList.add('active');
    } else {
        uploadTab.classList.remove('active');
        manualTab.classList.add('active');
        tabBtns[1].classList.add('active');
    }
}

const fileInput = document.getElementById('file-input');
const fileDropArea = document.getElementById('file-drop-area');
const fileNameDisplay = document.getElementById('file-name-display');

fileInput.addEventListener('change', function(e) {
    if (this.files && this.files[0]) {
        displayFileName(this.files[0].name);
    }
});

fileDropArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.style.borderColor = '#6366f1';
    this.style.background = '#f8fafc';
});

fileDropArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.style.borderColor = '#e2e8f0';
    this.style.background = 'transparent';
});

fileDropArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.style.borderColor = '#e2e8f0';
    this.style.background = 'transparent';
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
        fileInput.files = e.dataTransfer.files;
        displayFileName(e.dataTransfer.files[0].name);
    }
});

function displayFileName(filename) {
    fileNameDisplay.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
            <polyline points="13 2 13 9 20 9"></polyline>
        </svg>
        <span>${filename}</span>
    `;
    fileNameDisplay.style.display = 'flex';
}

document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('file-input');
    
    if (!fileInput.files || !fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    analyzeReport(formData);
});

document.getElementById('manual-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const hemoglobin = document.getElementById('hemoglobin').value;
    const bloodSugar = document.getElementById('blood_sugar').value;
    const cholesterol = document.getElementById('cholesterol').value;
    
    if (!hemoglobin || !bloodSugar || !cholesterol) {
        alert('Please enter all values');
        return;
    }
    
    const text = `Hemoglobin: ${hemoglobin}\nBlood Sugar: ${bloodSugar}\nCholesterol: ${cholesterol}`;
    
    const formData = new FormData();
    formData.append('text', text);
    
    analyzeReport(formData);
});

function analyzeReport(formData) {
    document.querySelector('.upload-section').style.display = 'none';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    
    fetch('/analyze', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        
        if (data.error) {
            alert('Error: ' + data.error);
            document.querySelector('.upload-section').style.display = 'block';
            return;
        }
        
        displayResults(data);
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('Error analyzing report: ' + error);
        document.querySelector('.upload-section').style.display = 'block';
    });
}

function displayResults(data) {
    // Display values with dash if missing
    document.getElementById('result-hemoglobin').textContent = 
        data.values.hemoglobin !== null ? data.values.hemoglobin + ' g/dL' : '- -';
    document.getElementById('result-blood-sugar').textContent = 
        data.values.blood_sugar !== null ? data.values.blood_sugar + ' mg/dL' : '- -';
    document.getElementById('result-cholesterol').textContent = 
        data.values.cholesterol !== null ? data.values.cholesterol + ' mg/dL' : '- -';
    
    const riskBadge = document.getElementById('risk-badge');
    riskBadge.textContent = data.risk_level + ' Risk';
    riskBadge.className = 'risk-badge risk-' + data.risk_level.toLowerCase();
    
    // Display risk score gauge if available
    if (data.risk_score !== undefined && typeof displayRiskGauge === 'function') {
        displayRiskGauge(data.risk_score, data.risk_color || '#16a34a');
        if (document.getElementById('risk-score-text')) {
            document.getElementById('risk-score-text').textContent = data.risk_message || '';
        }
    }
    
    document.getElementById('explanation-content').innerHTML = data.explanation;
    
    // Display health tips
    const tipsList = document.getElementById('health-tips-list');
    tipsList.innerHTML = '';
    if (data.tips && data.tips.length > 0) {
        data.tips.forEach(tip => {
            const li = document.createElement('li');
            li.textContent = tip;
            tipsList.appendChild(li);
        });
    }
    
    const hospitalSection = document.getElementById('hospital-section');
    if (data.risk_level === 'Medium' || data.risk_level === 'High') {
        hospitalSection.style.display = 'block';
    } else {
        hospitalSection.style.display = 'none';
    }
    
    // Store result for voice feature
    sessionStorage.setItem('lastResult', JSON.stringify(data));
    
    document.getElementById('results-section').style.display = 'block';
    
    // Check for emergency
    if (typeof checkEmergency === 'function') {
        checkEmergency(data);
    }
}

function getLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            findHospitals(position.coords.latitude, position.coords.longitude);
        },
        function(error) {
            alert('Unable to get your location. Please enable location services.');
        }
    );
}

function findHospitals(lat, lon) {
    fetch('/find-hospitals', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ lat: lat, lon: lon })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        displayHospitals(data.hospitals, data.maps_link);
    })
    .catch(error => {
        alert('Error finding hospitals: ' + error);
    });
}

function displayHospitals(hospitals, mapsLink) {
    const hospitalsList = document.getElementById('hospitals-list');
    
    if (hospitals.length === 0) {
        hospitalsList.innerHTML = '<p>No hospitals found nearby.</p>';
        return;
    }
    
    let html = '';
    hospitals.forEach(hospital => {
        html += `
            <div class="hospital-item">
                <div>
                    <div class="hospital-name">${hospital.name}</div>
                </div>
                <div class="hospital-distance">${hospital.distance} km</div>
            </div>
        `;
    });
    
    html += `<a href="${mapsLink}" target="_blank" class="btn btn-primary" style="margin-top: 16px; display: inline-block;">View on Google Maps</a>`;
    
    hospitalsList.innerHTML = html;
}

function resetForm() {
    document.getElementById('upload-form').reset();
    document.getElementById('manual-form').reset();
    document.getElementById('file-name-display').style.display = 'none';
    document.getElementById('results-section').style.display = 'none';
    document.querySelector('.upload-section').style.display = 'block';
    document.getElementById('hospitals-list').innerHTML = '';
    document.getElementById('health-tips-list').innerHTML = '';
}

function speakResults() {
    // Check if browser supports speech synthesis
    if (!window.speechSynthesis) {
        alert('Text-to-speech is not supported in your browser. Please try Chrome, Edge, or Safari.');
        return;
    }
    
    // Get stored result
    const resultStr = sessionStorage.getItem('lastResult');
    if (!resultStr) {
        alert('No results available to read. Please analyze a report first.');
        return;
    }
    
    // Show language selection modal
    showLanguageSelectionModal(JSON.parse(resultStr));
}

function showLanguageSelectionModal(data) {
    // Create modal HTML
    const modalHTML = `
        <div id="language-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 40px; border-radius: 16px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin: 0 0 24px 0; color: #1e293b;">ЁЯЧгя╕П Choose Language / рднрд╛рд╖рд╛ рдЪреБрдиреЗрдВ</h2>
                <p style="color: #64748b; margin-bottom: 24px;">Select your preferred language for voice report</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button onclick="speakInLanguage('en-US', 'English')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗмЁЯЗз English
                    </button>
                    <button onclick="speakInLanguage('hi-IN', 'Hindi')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ рд╣рд┐рдВрджреА (Hindi)
                    </button>
                    <button onclick="speakInLanguage('mr-IN', 'Marathi')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ рдорд░рд╛рдареА (Marathi)
                    </button>
                    <button onclick="speakInLanguage('ta-IN', 'Tamil')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ родрооро┐ро┤рпН (Tamil)
                    </button>
                    <button onclick="speakInLanguage('te-IN', 'Telugu')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ р░др▒Жр░▓р▒Бр░Чр▒Б (Telugu)
                    </button>
                    <button onclick="speakInLanguage('bn-IN', 'Bengali')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ ржмрж╛ржВрж▓рж╛ (Bengali)
                    </button>
                    <button onclick="speakInLanguage('gu-IN', 'Gujarati')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ ркЧрлБркЬрк░рк╛ркдрлА (Gujarati)
                    </button>
                    <button onclick="speakInLanguage('kn-IN', 'Kannada')" class="lang-btn" style="padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; background: white; cursor: pointer; font-size: 16px; transition: all 0.3s;">
                        ЁЯЗоЁЯЗ│ р▓Хр▓ир│Нр▓ир▓б (Kannada)
                    </button>
                </div>
                <button onclick="closeLanguageModal()" style="margin-top: 24px; padding: 12px 24px; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                    Cancel
                </button>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add hover effect to language buttons
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            this.style.color = 'white';
            this.style.borderColor = '#667eea';
            this.style.transform = 'scale(1.05)';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.background = 'white';
            this.style.color = '#1e293b';
            this.style.borderColor = '#e2e8f0';
            this.style.transform = 'scale(1)';
        });
    });
}

function closeLanguageModal() {
    const modal = document.getElementById('language-modal');
    if (modal) modal.remove();
}

function speakInLanguage(langCode, langName) {
    closeLanguageModal();
    
    const resultStr = sessionStorage.getItem('lastResult');
    const data = JSON.parse(resultStr);
    
    // Stop any ongoing speech
    window.speechSynthesis.cancel();
    
    // Get speech text in selected language
    let speechText = getTranslatedSpeechText(data, langCode);
    
    // Create speech utterance
    const utterance = new SpeechSynthesisUtterance(speechText);
    utterance.lang = langCode;
    utterance.rate = 0.85; // Slightly slower for clarity in all languages
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // Try to find voice for selected language
    const voices = window.speechSynthesis.getVoices();
    const langVoice = voices.find(voice => voice.lang === langCode || voice.lang.startsWith(langCode.split('-')[0]));
    if (langVoice) {
        utterance.voice = langVoice;
    }
    
    // Show speaking indicator
    const speakBtn = document.querySelector('button[onclick="speakResults()"]');
    if (speakBtn) {
        const originalText = speakBtn.innerHTML;
        speakBtn.innerHTML = `ЁЯФК Speaking in ${langName}...`;
        speakBtn.disabled = true;
        
        utterance.onend = function() {
            speakBtn.innerHTML = originalText;
            speakBtn.disabled = false;
        };
    }
    
    // Speak
    window.speechSynthesis.speak(utterance);
}

function getTranslatedSpeechText(data, langCode) {
    const hb = data.values.hemoglobin;
    const bs = data.values.blood_sugar;
    const chol = data.values.cholesterol;
    const risk = data.risk_level;
    
    // Language-specific templates
    const templates = {
        'en-US': `Your health analysis is complete. Your risk level is ${risk}. ${hb !== null ? `Hemoglobin is ${hb} grams per deciliter. ` : ''}${bs !== null ? `Blood sugar is ${bs} milligrams per deciliter. ` : ''}${chol !== null ? `Cholesterol is ${chol} milligrams per deciliter. ` : ''}${risk === 'High' ? 'Important: Please consult a healthcare professional immediately.' : risk === 'Medium' ? 'We recommend scheduling a checkup with your doctor.' : 'Continue maintaining a healthy lifestyle.'}`,
        
        'hi-IN': `рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рд╕реНрдереНрдп рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдкреВрд░реНрдг рд╣реЛ рдЧрдпрд╛ рд╣реИред рдЖрдкрдХрд╛ рдЬреЛрдЦрд┐рдо рд╕реНрддрд░ ${risk} рд╣реИред ${hb !== null ? `рд╣реАрдореЛрдЧреНрд▓реЛрдмрд┐рди ${hb} рдЧреНрд░рд╛рдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рд╣реИред ` : ''}${bs !== null ? `рд░рдХреНрдд рд╢рд░реНрдХрд░рд╛ ${bs} рдорд┐рд▓реАрдЧреНрд░рд╛рдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рд╣реИред ` : ''}${chol !== null ? `рдХреЛрд▓реЗрд╕реНрдЯреНрд░реЙрд▓ ${chol} рдорд┐рд▓реАрдЧреНрд░рд╛рдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рд╣реИред ` : ''}${risk === 'High' ? 'рдорд╣рддреНрд╡рдкреВрд░реНрдг: рдХреГрдкрдпрд╛ рддреБрд░рдВрдд рдбреЙрдХреНрдЯрд░ рд╕реЗ рдкрд░рд╛рдорд░реНрд╢ рд▓реЗрдВред' : risk === 'Medium' ? 'рд╣рдо рдЕрдиреБрд╢рдВрд╕рд╛ рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдбреЙрдХреНрдЯрд░ рд╕реЗ рдЬрд╛рдВрдЪ рдХрд░рд╛рдПрдВред' : 'рд╕реНрд╡рд╕реНрде рдЬреАрд╡рдирд╢реИрд▓реА рдмрдирд╛рдП рд░рдЦреЗрдВред'}`,
        
        'mr-IN': `рддреБрдордЪреЗ рдЖрд░реЛрдЧреНрдп рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдкреВрд░реНрдг рдЭрд╛рд▓реЗ рдЖрд╣реЗред рддреБрдордЪрд╛ рдЬреЛрдЦреАрдо рдкрд╛рддрд│реА ${risk} рдЖрд╣реЗред ${hb !== null ? `рд╣рд┐рдореЛрдЧреНрд▓реЛрдмрд┐рди ${hb} рдЧреНрд░реЕрдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рдЖрд╣реЗред ` : ''}${bs !== null ? `рд░рдХреНрдд рд╕рд╛рдЦрд░ ${bs} рдорд┐рд▓рд┐рдЧреНрд░реЕрдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рдЖрд╣реЗред ` : ''}${chol !== null ? `рдХреЛрд▓реЗрд╕реНрдЯреЗрд░реЙрд▓ ${chol} рдорд┐рд▓рд┐рдЧреНрд░реЕрдо рдкреНрд░рддрд┐ рдбреЗрд╕реАрд▓реАрдЯрд░ рдЖрд╣реЗред ` : ''}${risk === 'High' ? 'рдорд╣рддреНрддреНрд╡рд╛рдЪреЗ: рдХреГрдкрдпрд╛ рд▓рдЧреЗрдЪ рдбреЙрдХреНрдЯрд░рд╛рдВрдЪрд╛ рд╕рд▓реНрд▓рд╛ рдШреНрдпрд╛ред' : risk === 'Medium' ? 'рдЖрдореНрд╣реА рд╢рд┐рдлрд╛рд░рд╕ рдХрд░рддреЛ рдХреА рддреБрдореНрд╣реА рдбреЙрдХреНрдЯрд░рд╛рдВрдХрдбреВрди рддрдкрд╛рд╕рдгреА рдХрд░рд╛ред' : 'рдирд┐рд░реЛрдЧреА рдЬреАрд╡рдирд╢реИрд▓реА рдЪрд╛рд▓реВ рдареЗрд╡рд╛ред'}`,
        
        'ta-IN': `роЙроЩрпНроХро│рпН роЪрпБроХро╛родро╛ро░ рокроХрпБрокрпНрокро╛ропрпНро╡рпБ роорпБроЯро┐роирпНродродрпБ. роЙроЩрпНроХро│рпН роЖрокродрпНродрпБ роиро┐ро▓рпИ ${risk} роЖроХрпБроорпН. ${hb !== null ? `ро╣рпАроорпЛроХрпБро│рпЛрокро┐ройрпН ${hb} роХро┐ро░ро╛роорпН рокрпЖро░рпН роЯрпЖроЪро┐ро▓ро┐роЯрпНроЯро░рпН. ` : ''}${bs !== null ? `роЗро░родрпНрод роЪро░рпНроХрпНроХро░рпИ ${bs} рооро┐ро▓рпНро▓ро┐роХро┐ро░ро╛роорпН рокрпЖро░рпН роЯрпЖроЪро┐ро▓ро┐роЯрпНроЯро░рпН. ` : ''}${chol !== null ? `роХрпКро▓ро╕рпНроЯро┐ро░ро╛ро▓рпН ${chol} рооро┐ро▓рпНро▓ро┐роХро┐ро░ро╛роорпН рокрпЖро░рпН роЯрпЖроЪро┐ро▓ро┐роЯрпНроЯро░рпН. ` : ''}${risk === 'High' ? 'роорпБроХрпНроХро┐ропрооро╛ройродрпБ: роЙроЯройроЯро┐ропро╛роХ рооро░рпБродрпНродрпБро╡ро░рпИ роЕрогрпБроХро╡рпБроорпНред' : risk === 'Medium' ? 'рооро░рпБродрпНродрпБро╡ро░ро┐роЯроорпН рокро░ро┐роЪрпЛродройрпИ роЪрпЖропрпНропрпБрооро╛ро▒рпБ рокро░ро┐роирпНродрпБро░рпИроХрпНроХро┐ро▒рпЛроорпНред' : 'роЖро░рпЛроХрпНроХро┐ропрооро╛рой ро╡ро╛ро┤рпНроХрпНроХрпИ роорпБро▒рпИропрпИ родрпКроЯро░ро╡рпБроорпНред'}`,
        
        'te-IN': `р░ор▒А р░Жр░░р▒Лр░Чр▒Нр░п р░╡р░┐р░╢р▒Нр░▓р▒Зр░╖р░г р░кр▒Вр░░р▒Нр░др░пр░┐р░Вр░жр░┐. р░ор▒А р░░р░┐р░╕р▒Нр░Хр▒Н р░╕р▒Нр░ер░╛р░пр░┐ ${risk}. ${hb !== null ? `р░╣р░┐р░ор▒Лр░Чр▒Нр░▓р▒Лр░мр░┐р░ир▒Н ${hb} р░Чр▒Нр░░р░╛р░ор▒Бр░▓р▒Б р░кр░░р▒Н р░бр▒Жр░╕р░┐р░▓р░┐р░Яр░░р▒Н. ` : ''}${bs !== null ? `р░мр▒Нр░▓р░бр▒Н р░╖р▒Бр░Чр░░р▒Н ${bs} р░ор░┐р░▓р▒Нр░▓р▒Ар░Чр▒Нр░░р░╛р░ор▒Бр░▓р▒Б р░кр░░р▒Н р░бр▒Жр░╕р░┐р░▓р░┐р░Яр░░р▒Н. ` : ''}${chol !== null ? `р░Хр▒Кр░▓р▒Жр░╕р▒Нр░Яр▒Нр░░р░╛р░▓р▒Н ${chol} р░ор░┐р░▓р▒Нр░▓р▒Ар░Чр▒Нр░░р░╛р░ор▒Бр░▓р▒Б р░кр░░р▒Н р░бр▒Жр░╕р░┐р░▓р░┐р░Яр░░р▒Н. ` : ''}${risk === 'High' ? 'р░ор▒Бр░Цр▒Нр░пр░ор▒Ир░ир░жр░┐: р░жр░пр░Ър▒Зр░╕р░┐ р░╡р▒Жр░Вр░Яр░ир▒З р░╡р▒Ир░жр▒Нр░пр▒Бр░бр░┐р░ир░┐ р░╕р░Вр░кр▒Нр░░р░жр░┐р░Вр░Ър░Вр░бр░┐ред' : risk === 'Medium' ? 'р░╡р▒Ир░жр▒Нр░пр▒Бр░бр░┐р░др▒Л р░Ър▒Жр░Хр░кр▒Н р░Ър▒Зр░пр░┐р░Вр░Ър▒Бр░Хр▒Лр░╡р░╛р░▓р░ир░┐ р░╕р░┐р░лр░╛р░░р░╕р▒Б р░Ър▒Зр░╕р▒Нр░др▒Бр░ир▒Нр░ир░╛р░ор▒Бред' : 'р░Жр░░р▒Лр░Чр▒Нр░пр░Хр░░р░ор▒Ир░и р░Ьр▒Ар░╡р░ир░╢р▒Ир░▓р░┐р░ир░┐ р░Хр▒Кр░ир░╕р░╛р░Чр░┐р░Вр░Ър░Вр░бр░┐ред'}`,
        
        'bn-IN': `ржЖржкржирж╛рж░ рж╕рзНржмрж╛рж╕рзНржерзНржп ржмрж┐рж╢рзНрж▓рзЗрж╖ржг рж╕ржорзНржкрзВрж░рзНржг рж╣ржпрж╝рзЗржЫрзЗред ржЖржкржирж╛рж░ ржЭрзБржБржХрж┐рж░ ржорж╛рждрзНрж░рж╛ ${risk}ред ${hb !== null ? `рж╣рж┐ржорзЛржЧрзНрж▓рзЛржмрж┐ржи ${hb} ржЧрзНрж░рж╛ржо ржкрзНрж░рждрж┐ ржбрзЗрж╕рж┐рж▓рж┐ржЯрж╛рж░ред ` : ''}${bs !== null ? `рж░ржХрзНрждрзЗрж░ рж╢рж░рзНржХрж░рж╛ ${bs} ржорж┐рж▓рж┐ржЧрзНрж░рж╛ржо ржкрзНрж░рждрж┐ ржбрзЗрж╕рж┐рж▓рж┐ржЯрж╛рж░ред ` : ''}${chol !== null ? `ржХрзЛрж▓рзЗрж╕рзНржЯрзЗрж░рж▓ ${chol} ржорж┐рж▓рж┐ржЧрзНрж░рж╛ржо ржкрзНрж░рждрж┐ ржбрзЗрж╕рж┐рж▓рж┐ржЯрж╛рж░ред ` : ''}${risk === 'High' ? 'ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг: ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржЕржмрж┐рж▓ржорзНржмрзЗ ржбрж╛ржХрзНрждрж╛рж░рзЗрж░ ржкрж░рж╛ржорж░рзНрж╢ ржирж┐ржиред' : risk === 'Medium' ? 'ржЖржорж░рж╛ рж╕рзБржкрж╛рж░рж┐рж╢ ржХрж░рж┐ ржпрзЗ ржЖржкржирж┐ ржбрж╛ржХрзНрждрж╛рж░рзЗрж░ ржХрж╛ржЫрзЗ ржЪрзЗржХржЖржк ржХрж░рж╛ржиред' : 'рж╕рзНржмрж╛рж╕рзНржерзНржпржХрж░ ржЬрзАржмржиржпрж╛рждрзНрж░рж╛ ржмржЬрж╛ржпрж╝ рж░рж╛ржЦрзБржиред'}`,
        
        'gu-IN': `ркдркорк╛рк░рлБркВ ркЖрк░рлЛркЧрлНркп рк╡рк┐рк╢рлНрк▓рлЗрк╖ркг рккрлВрк░рлНркг ркеркпрлБркВ ркЫрлЗред ркдркорк╛рк░рлБркВ ркЬрлЛркЦрко рк╕рлНркдрк░ ${risk} ркЫрлЗред ${hb !== null ? `рк╣рк┐ркорлЛркЧрлНрк▓рлЛркмрк┐рки ${hb} ркЧрлНрк░рк╛рко рккрлНрк░ркдрк┐ ркбрлЗрк╕рк┐рк▓рк┐ркЯрк░ ркЫрлЗред ` : ''}${bs !== null ? `ркмрлНрк▓ркб рк╕рлБркЧрк░ ${bs} ркорк┐рк▓рк┐ркЧрлНрк░рк╛рко рккрлНрк░ркдрк┐ ркбрлЗрк╕рк┐рк▓рк┐ркЯрк░ ркЫрлЗред ` : ''}${chol !== null ? `ркХрлЛрк▓рлЗрк╕рлНркЯрлНрк░рлЛрк▓ ${chol} ркорк┐рк▓рк┐ркЧрлНрк░рк╛рко рккрлНрк░ркдрк┐ ркбрлЗрк╕рк┐рк▓рк┐ркЯрк░ ркЫрлЗред ` : ''}${risk === 'High' ? 'ркорк╣ркдрлНрк╡рккрлВрк░рлНркг: ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркдрк╛ркдрлНркХрк╛рк▓рк┐ркХ ркбрлЙркХрлНркЯрк░ркирлА рк╕рк▓рк╛рк╣ рк▓рлЛред' : risk === 'Medium' ? 'ркЕркорлЗ ркнрк▓рк╛ркоркг ркХрк░рлАркП ркЫрлАркП ркХрлЗ ркдркорлЗ ркбрлЙркХрлНркЯрк░ рккрк╛рк╕рлЗ ркдрккрк╛рк╕ ркХрк░рк╛рк╡рлЛред' : 'рк╕рлНрк╡рк╕рлНрке ркЬрлАрк╡ркирк╢рлИрк▓рлА ркЬрк╛рк│рк╡рлА рк░рк╛ркЦрлЛред'}`,
        
        'kn-IN': `р▓ир▓┐р▓ор│Нр▓о р▓Жр▓░р│Лр▓Чр│Нр▓п р▓╡р▓┐р▓╢р│Нр▓▓р│Зр▓╖р▓гр│Ж р▓кр│Вр▓░р│Нр▓гр▓Чр│Кр▓Вр▓бр▓┐р▓жр│Жред р▓ир▓┐р▓ор│Нр▓о р▓Ер▓кр▓╛р▓пр▓ж р▓ор▓Яр│Нр▓Я ${risk} р▓Жр▓Чр▓┐р▓жр│Жред ${hb !== null ? `р▓╣р▓┐р▓ор│Лр▓Чр│Нр▓▓р│Лр▓мр▓┐р▓ир│Н ${hb} р▓Чр│Нр▓░р▓╛р▓В р▓кр│Нр▓░р▓др▓┐ р▓бр│Жр▓╕р▓┐р▓▓р▓┐р▓Яр▓░р│Нред ` : ''}${bs !== null ? `р▓░р▓Хр│Нр▓др▓ж р▓╕р▓Хр│Нр▓Хр▓░р│Ж ${bs} р▓ор▓┐р▓▓р▓┐р▓Чр│Нр▓░р▓╛р▓В р▓кр│Нр▓░р▓др▓┐ р▓бр│Жр▓╕р▓┐р▓▓р▓┐р▓Яр▓░р│Нред ` : ''}${chol !== null ? `р▓Хр│Кр▓▓р│Жр▓╕р│Нр▓Яр▓░р▓╛р▓▓р│Н ${chol} р▓ор▓┐р▓▓р▓┐р▓Чр│Нр▓░р▓╛р▓В р▓кр│Нр▓░р▓др▓┐ р▓бр│Жр▓╕р▓┐р▓▓р▓┐р▓Яр▓░р│Нред ` : ''}${risk === 'High' ? 'р▓ор│Бр▓Цр│Нр▓пр▓╡р▓╛р▓жр│Бр▓жр│Б: р▓жр▓пр▓╡р▓┐р▓Яр│Нр▓Яр│Б р▓др▓Хр│Нр▓╖р▓г р▓╡р│Ир▓жр│Нр▓пр▓░р▓ир│Нр▓ир│Б р▓╕р▓Вр▓кр▓░р│Нр▓Хр▓┐р▓╕р▓┐ред' : risk === 'Medium' ? 'р▓╡р│Ир▓жр│Нр▓пр▓░р│Кр▓Вр▓жр▓┐р▓Чр│Ж р▓др▓кр▓╛р▓╕р▓гр│Ж р▓ор▓╛р▓бр▓┐р▓╕р▓┐р▓Хр│Кр▓│р│Нр▓│р│Бр▓╡р▓Вр▓др│Ж р▓ир▓╛р▓╡р│Б р▓╢р▓┐р▓лр▓╛р▓░р▓╕р│Б р▓ор▓╛р▓бр│Бр▓др│Нр▓др│Зр▓╡р│Жред' : 'р▓Жр▓░р│Лр▓Чр│Нр▓пр▓Хр▓░ р▓Ьр│Ар▓╡р▓ир▓╢р│Ир▓▓р▓┐р▓пр▓ир│Нр▓ир│Б р▓ор│Бр▓Вр▓жр│Бр▓╡р▓░р▓┐р▓╕р▓┐ред'}`
    };
    
    return templates[langCode] || templates['en-US'];
    }
    
    // Speak the text
    window.speechSynthesis.speak(utterance);
    
    // Visual feedback
    const speakButton = event.target;
    const originalText = speakButton.innerHTML;
    speakButton.innerHTML = 'ЁЯФЗ Stop Reading';
    speakButton.classList.add('btn-danger');
    
    utterance.onend = function() {
        speakButton.innerHTML = originalText;
        speakButton.classList.remove('btn-danger');
    };
    
    // Allow stopping the speech
    speakButton.onclick = function() {
        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            speakButton.innerHTML = originalText;
            speakButton.classList.remove('btn-danger');
            speakButton.onclick = function() { speakResults(); };
        }
    };
}

// Load voices when they become available
if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = function() {
        window.speechSynthesis.getVoices();
    };
}
